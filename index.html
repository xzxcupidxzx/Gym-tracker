<!DOCTYPE html>
<html lang="vi">
<head>
<script>window.app = window.app || {};</script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover">
    <title>Gym Tracker - Quản lý tập luyện thông minh</title>
    <meta name="description" content="Ứng dụng theo dõi và quản lý tập luyện gym với AI">
    <meta name="theme-color" content="#4CAF50">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Gym Tracker">

    <!-- PWA -->
<link rel="icon" type="image/x-icon" href="icon/favicon.ico">
    <link rel="icon" type="image/png" sizes="96x96" href="icon/Gym-favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="192x192" href="icon/Gym-192x192.png">
    <link rel="apple-touch-icon" href="icon/Gym-apple-touch-icon.png">
    <link rel="stylesheet" href="css/main.css">
    
    <!-- Chart.js Preload (cho analytics) -->
	<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>

<script>
(function(){
  function setVh(){
    var vh = window.innerHeight * 0.01;
    document.documentElement.style.setProperty('--vh', vh + 'px');
  }
  setVh();
  window.addEventListener('resize', setVh);
  window.addEventListener('orientationchange', setVh);
})();
</script>

</head>
<body>
    <audio id="sound-beep" src="sounds/beep.mp3" preload="auto"></audio>
    <audio id="sound-done" src="sounds/done.mp3" preload="auto"></audio>

    <!-- Install Banner -->
    <div id="install-banner" class="install-banner" style="display:none;">
        <div class="install-content">
            <span>📱 Cài đặt Gym Tracker để dùng offline</span>
            <button class="btn btn-primary btn-sm" id="install-btn">Cài đặt</button>
            <button class="btn-close" onclick="hideInstallBanner()">×</button>
        </div>
    </div>

    <!-- Offline Indicator -->
    <div id="offline-indicator" class="offline-indicator" style="display:none;">
        <span>📡 Đang offline</span>
    </div>

    <!-- Header -->
    <header class="app-header">
        <div class="container">
            <div class="header-content">
                <h1 class="app-title">💪 Gym Tracker</h1>
                <div class="header-actions">
                    <button class="icon-btn" onclick="app.openBackendSettings()" title="Sync Settings">
                        <span id="sync-status">☁️</span>
                    </button>
                    <button class="icon-btn" onclick="app.openSettings()" title="Settings">⚙️</button>
                    <button class="menu-toggle" id="menu-toggle" aria-label="Toggle menu">
                        <span></span><span></span><span></span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Navigation -->
    <nav class="app-nav" id="app-nav">
        <div class="container">
            <div class="nav-links">
                <a href="#home" class="nav-link active" data-page="home">
                    <span class="nav-icon">🏠</span>
                    <span class="nav-text">Trang chủ</span>
                </a>
                <a href="#templates" class="nav-link" data-page="templates">
                    <span class="nav-icon">📋</span>
                    <span class="nav-text">Templates</span>
                </a>
                <a href="#exercises" class="nav-link" data-page="exercises">
                    <span class="nav-icon">🏋️</span>
                    <span class="nav-text">Bài tập</span>
                </a>
                <a href="#analytics" class="nav-link" data-page="analytics">
                    <span class="nav-icon">📊</span>
                    <span class="nav-text">Analytics</span>
                </a>
                <a href="#history" class="nav-link" data-page="history">
                    <span class="nav-icon">📅</span>
                    <span class="nav-text">Lịch sử</span>
                </a>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="app-main">
        <div class="container">
            <!-- Home Page -->
            <section id="home-page" class="page active">
                <div id="ai-suggestion-banner" class="ai-suggestion-banner" style="display:none;">
                    <div class="ai-content">
                        <span class="ai-icon">🤖</span>
                        <div class="ai-text">
                            <strong>AI Suggestion</strong>
                            <p id="ai-suggestion-text"></p>
                        </div>
                        <button class="btn btn-primary btn-sm" onclick="app.acceptAISuggestion()">Sử dụng</button>
                    </div>
                </div>
                <div class="stats-grid">
                    <div class="stat-card"><div class="stat-icon">🏋️</div><div class="stat-content"><div class="stat-value" id="total-workouts">0</div><div class="stat-label">Buổi tập</div></div></div>
                    <div class="stat-card"><div class="stat-icon">📋</div><div class="stat-content"><div class="stat-value" id="total-templates">0</div><div class="stat-label">Templates</div></div></div>
                    <div class="stat-card"><div class="stat-icon">🔥</div><div class="stat-content"><div class="stat-value" id="this-week">0</div><div class="stat-label">Tuần này</div></div></div>
                    <div class="stat-card"><div class="stat-icon">💪</div><div class="stat-content"><div class="stat-value" id="total-volume">0</div><div class="stat-label">Tổng KG</div></div></div>
                </div>
                <div class="quick-actions">
                    <button class="quick-action-btn primary" onclick="window.app&&app.startQuickWorkout?app.startQuickWorkout():alert('Ứng dụng chưa khởi tạo xong. Hãy tải lại trang.')">
                        <span class="btn-icon">🚀</span>
                        <span class="btn-text">Bắt đầu tập</span>
                    </button>
                    <button class="quick-action-btn" onclick="app.getAIWorkoutSuggestion()">
                        <span class="btn-icon">🤖</span>
                        <span class="btn-text">AI Suggest</span>
                    </button>
                    <button class="quick-action-btn" onclick="app.createTemplate()" title="Tạo template">
                        <span class="btn-icon">➕</span>
                        <span class="btn-text">Tạo template</span>
                    </button>
                </div>
                <div class="section">
                    <div class="section-header">
                        <h2 class="section-title">Templates gần đây</h2>
                        <a href="#templates" class="section-link" onclick="app.loadPage('templates')">Xem tất cả →</a>
                    </div>
                    <div class="templates-grid" id="recent-templates"></div>
                </div>
                <div class="section">
                    <div class="section-header">
                        <h2 class="section-title">🏆 Personal Records</h2>
                        <a href="#analytics" class="section-link" onclick="app.loadPage('analytics')">Xem analytics →</a>
                    </div>
                    <div id="recent-prs" class="pr-list"></div>
                </div>
            </section>

            <!-- Templates Page -->
            <section id="templates-page" class="page">
                <div class="page-header">
                    <h2 class="page-title">📋 Templates</h2>
                    <div class="header-actions">
                        <button class="btn btn-primary" onclick="app.createTemplate()" title="Tạo template">
                            <span class="btn-icon">➕</span></button>
                        <button class="btn btn-secondary" onclick="document.getElementById('import-template-file').click()" title="Import template (JSON)">
                            <span class="btn-icon">📥</span></button>
                        <button class="btn btn-secondary" onclick="app.exportTemplates()" title="Export templates">
                            <span class="btn-icon">📤</span></button>
                    </div>
                </div>
                
                <div class="filters">
                    <input type="search" class="search-input" id="template-search" placeholder="🔍 Tìm kiếm templates...">
                    <select class="filter-select" id="template-filter">
                        <option value="">Tất cả độ khó</option>
                        <option value="beginner">🌱 Người mới</option>
                        <option value="intermediate">⚡ Trung cấp</option>
                        <option value="advanced">🔥 Nâng cao</option>
                    </select>
                </div>
                
                <input type="file" id="import-template-file" accept=".json" style="display:none;" onchange="app.importTemplates(event)">
                <div class="templates-grid" id="all-templates"></div>
            </section>

            <!-- Exercises Page - FIXED -->
            <section id="exercises-page" class="page">
                <div class="page-header">
                    <h2 class="page-title">🏋️ Quản lý bài tập</h2>
                    <div class="header-actions">
                        <button class="btn btn-primary" onclick="app.openAddExerciseModal()">
                            <span class="btn-icon">➕</span>Thêm bài tập
                        </button>
                        <button class="btn btn-secondary" onclick="document.getElementById('import-exercise-file').click()">
                            <span class="btn-icon">📥</span>Import
                        </button>
                        <button class="btn btn-secondary" onclick="app.exportExercises()">
                            <span class="btn-icon">📤</span>Export
                        </button>
                    </div>
                </div>
                
                <!-- Exercise Filters -->
                <div class="filters">
                    <input type="search" class="search-input" id="exercise-search" placeholder="🔍 Tìm kiếm bài tập...">
                    <select class="filter-select" id="muscle-filter">
                        <option value="">Tất cả nhóm cơ</option>
                        <option value="chest">💪 Ngực</option>
                        <option value="back">🔙 Lưng</option>
                        <option value="legs">🦵 Chân</option>
                        <option value="shoulders">💪 Vai</option>
                        <option value="arms">💪 Tay</option>
                        <option value="core">🔥 Bụng</option>
                        <option value="cardio">❤️ Cardio</option>
                        <option value="fullbody">🏃 Toàn thân</option>
                        <option value="olympic">🏋️ Olympic</option>
                        <option value="other">💪 Khác</option>
                    </select>
                    <select class="filter-select" id="equipment-filter">
                        <option value="">Tất cả thiết bị</option>
                        <option value="bodyweight">Bodyweight</option>
                        <option value="barbell">Barbell</option>
                        <option value="dumbbell">Dumbbell</option>
                        <option value="machine">Machine</option>
                        <option value="cable">Cable</option>
                    </select>
                </div>
                
                <input type="file" id="import-exercise-file" accept=".json" style="display:none;" onchange="app.importExercises(event)">
                
                <!-- Exercise Stats -->
                <div class="exercise-stats" style="margin-bottom: 20px;">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon">🏋️</div>
                            <div class="stat-content">
                                <div class="stat-value" id="total-exercises-count">0</div>
                                <div class="stat-label">Tổng bài tập</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">💪</div>
                            <div class="stat-content">
                                <div class="stat-value" id="strength-exercises-count">0</div>
                                <div class="stat-label">Strength</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">❤️</div>
                            <div class="stat-content">
                                <div class="stat-value" id="cardio-exercises-count">0</div>
                                <div class="stat-label">Cardio</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">🤸</div>
                            <div class="stat-content">
                                <div class="stat-value" id="bodyweight-exercises-count">0</div>
                                <div class="stat-label">Bodyweight</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Exercise Grid -->
                <div class="exercises-grid" id="all-exercises"></div>
            </section>

            <!-- Analytics Page - UPDATED -->
            <section id="analytics-page" class="page">
                <div class="page-header">
                    <h2 class="page-title">📊 Analytics & Insights</h2>
                    <div class="header-actions">
                        <button class="btn btn-secondary" onclick="app.generateReport()">
                            <span class="btn-icon">📄</span>Generate Report
                        </button>
                        <button class="btn btn-secondary" onclick="app.refreshAnalytics()">
                            <span class="btn-icon">🔄</span>Refresh
                        </button>
                    </div>
                </div>
                
                <div class="time-range-selector">
                    <button class="time-btn active" data-range="week">Week</button>
                    <button class="time-btn" data-range="month">Month</button>
                    <button class="time-btn" data-range="quarter">Quarter</button>
                    <button class="time-btn" data-range="year">Year</button>
                </div>
                
                <div class="analytics-grid">
                    <div class="chart-container">
                        <h3>📈 Volume Progression</h3>
                        <div class="chart-wrapper">
                            <canvas id="volume-chart"></canvas>
                        </div>
                    </div>
                    
                    <div class="chart-container">
                        <h3>🎯 Muscle Distribution</h3>
                        <div class="chart-wrapper">
                            <canvas id="muscle-distribution-chart"></canvas>
                        </div>
                    </div>
                    
                    <div class="chart-container">
                        <h3>📅 Workout Frequency</h3>
                        <div class="chart-wrapper">
                            <canvas id="frequency-chart"></canvas>
                        </div>
                    </div>
                    
                    <div class="chart-container">
                        <h3>🏆 Personal Records</h3>
                        <div class="chart-wrapper">
                            <canvas id="pr-chart"></canvas>
                        </div>
                    </div>
                    
                    <div class="chart-container">
                        <h3>💪 Strength Standards</h3>
                        <div class="chart-wrapper">
                            <canvas id="strength-chart"></canvas>
                        </div>
                    </div>
                    
                    <div class="chart-container">
                        <h3>🔮 Progress Prediction</h3>
                        <div class="chart-wrapper">
                            <canvas id="prediction-chart"></canvas>
                        </div>
                    </div>
                </div>
                
                <!-- Analytics Summary -->
                <div class="analytics-summary">
                    <div class="summary-card">
                        <h4>🎯 This Week</h4>
                        <div id="weekly-summary" class="summary-content">
                            <div class="summary-stat">
                                <span class="stat-label">Workouts:</span>
                                <span class="stat-value" id="weekly-workouts">-</span>
                            </div>
                            <div class="summary-stat">
                                <span class="stat-label">Volume:</span>
                                <span class="stat-value" id="weekly-volume">-</span>
                            </div>
                            <div class="summary-stat">
                                <span class="stat-label">PRs:</span>
                                <span class="stat-value" id="weekly-prs">-</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="summary-card">
                        <h4>📊 All Time</h4>
                        <div id="alltime-summary" class="summary-content">
                            <div class="summary-stat">
                                <span class="stat-label">Total Workouts:</span>
                                <span class="stat-value" id="total-workouts-analytics">-</span>
                            </div>
                            <div class="summary-stat">
                                <span class="stat-label">Total Volume:</span>
                                <span class="stat-value" id="total-volume-analytics">-</span>
                            </div>
                            <div class="summary-stat">
                                <span class="stat-label">Avg/Week:</span>
                                <span class="stat-value" id="avg-workouts-week">-</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="insights-section">
                    <h3>🤖 AI Insights</h3>
                    <div id="ai-insights" class="insights-grid">
                        <div class="insight-card">
                            <div class="insight-icon">💡</div>
                            <div class="insight-content">
                                <h4>Smart Recommendations</h4>
                                <p>AI insights will appear here based on your workout data and progress patterns.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- History Page -->
            <section id="history-page" class="page">
                <div class="page-header">
                    <h2 class="page-title">📅 Lịch sử tập luyện</h2>
                    <div class="header-actions">
                        <input type="file" id="import-file" accept=".json" style="display:none;" onchange="app.handleImportFile(event)">
                        <button class="btn btn-secondary" onclick="document.getElementById('import-file').click()" title="Import (JSON)"><span class="btn-icon">📥</span></button>
                        <button class="btn btn-secondary" onclick="app.exportData()" title="Export (JSON)"><span class="btn-icon">📤</span></button>
                    </div>
                </div>
                <div class="view-toggle">
                    <button class="view-btn active" data-view="list">List</button>
                    <button class="view-btn" data-view="calendar">Calendar</button>
                </div>
                <div class="history-list" id="workout-history"></div>
                <div class="calendar-view" id="workout-calendar" style="display:none;"></div>
            </section>
        </div>
    </main>

    <!-- Workout Modal -->
    <div class="modal" id="workout-modal">
        <div class="modal-content workout-modal">
            <div class="modal-header">
                <h3 id="workout-title">Workout</h3>
                <div id="workout-timer-box">
                    <span class="timer-icon">⏱️</span>
                    <span class="timer-text" id="workout-timer">00:00</span>
                </div>
                <button class="modal-close" onclick="app.closeWorkout()">✕</button>
            </div>
            <div class="modal-body">
                <div class="workout-exercises" id="workout-exercises"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="app.pauseWorkout()">Tạm dừng</button>
                <button class="btn btn-primary" onclick="app.finishWorkout()">Hoàn thành</button>
            </div>
        </div>
    </div>

    <!-- Template Form Modal -->
    <div class="modal" id="template-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="template-form-title">Tạo Template</h3>
                <button class="modal-close" onclick="app.closeTemplateForm()">✕</button>
            </div>
            <form id="template-form" class="modal-body">
                <div class="form-group">
                    <label for="template-name">Tên template</label>
                    <input type="text" id="template-name" class="form-input" placeholder="VD: Push Day, Leg Day..." required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="template-level">Độ khó</label>
                        <select id="template-level" class="form-select">
                            <option value="">Chọn độ khó</option>
                            <option value="beginner">🌱 Người mới</option>
                            <option value="intermediate">⚡ Trung cấp</option>
                            <option value="advanced">🔥 Nâng cao</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="template-duration">Thời gian (phút)</label>
                        <input type="number" id="template-duration" class="form-input" placeholder="60" min="15" max="180">
                    </div>
                </div>
                <div class="form-group">
                    <label>Bài tập</label>
                    <div class="selected-exercises" id="selected-exercises"></div>
                    <button type="button" class="btn btn-secondary btn-block" onclick="app.selectExercises()">➕ Thêm bài tập</button>
                </div>
            </form>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="app.closeTemplateForm()">Hủy</button>
                <button class="btn btn-primary" onclick="app.saveTemplate()">Lưu template</button>
            </div>
        </div>
    </div>

    <!-- Template Preview Modal -->
    <div class="modal" id="template-preview-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="template-preview-title">Template</h3>
                <button class="modal-close" onclick="app.closeTemplatePreview()">✕</button>
            </div>
            <div class="modal-body">
                <div id="template-preview-list"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="app.editTemplateFromPreview()">Edit</button>
                <button class="btn btn-primary" onclick="app.startWorkoutFromPreview()">Start Workout</button>
            </div>
        </div>
    </div>

    <!-- Exercise Selection Modal -->
    <div class="modal" id="exercise-select-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Chọn bài tập</h3>
                <button class="modal-close" onclick="app.closeExerciseSelect()">✕</button>
            </div>
            <div class="modal-body">
                <input type="search" class="search-input" id="exercise-select-search" placeholder="🔍 Tìm kiếm bài tập...">
                <div class="exercise-select-list" id="exercise-select-list"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="app.closeExerciseSelect()">Hủy</button>
                <button class="btn btn-primary" onclick="app.confirmExerciseSelection()">Xác nhận</button>
            </div>
        </div>
    </div>

    <!-- Exercise Add Modal - FIXED -->
	<div class="modal" id="exercise-add-modal">
		<div class="modal-content">
			<div class="modal-header">
				<h3>➕ Thêm bài tập mới</h3>
				<button class="modal-close" onclick="app.closeAddExerciseModal()">✕</button>
			</div>
			<div class="modal-body">
				<form id="exercise-add-form" onsubmit="event.preventDefault(); return false;">
					<div class="form-group">
						<label for="exercise-add-name">Tên bài tập *</label>
						<input type="text" id="exercise-add-name" class="form-input" placeholder="VD: Bench Press, Squat..." required>
					</div>
					
					<div class="form-group">
						<label>Nhóm cơ *</label>
						<div id="exercise-add-muscle-group" class="chip-group" style="margin-top:8px;">
							<button type="button" class="chip-btn" data-value="chest">💪 Ngực</button>
							<button type="button" class="chip-btn" data-value="back">🔙 Lưng</button>
							<button type="button" class="chip-btn" data-value="legs">🦵 Chân</button>
							<button type="button" class="chip-btn" data-value="shoulders">💪 Vai</button>
							<button type="button" class="chip-btn" data-value="arms">💪 Tay</button>
							<button type="button" class="chip-btn" data-value="core">🔥 Bụng</button>
							<button type="button" class="chip-btn" data-value="cardio">❤️ Cardio</button>
							<button type="button" class="chip-btn" data-value="fullbody">🏃 Toàn thân</button>
							<button type="button" class="chip-btn" data-value="olympic">🏋️ Olympic</button>
							<button type="button" class="chip-btn" data-value="other">💪 Khác</button>
						</div>
						<input type="hidden" id="exercise-add-muscle" required>
					</div>
					
					<div class="form-row">
						<div class="form-group">
							<label for="exercise-add-type">Loại bài tập</label>
							<select id="exercise-add-type" class="form-select">
								<option value="strength">💪 Strength</option>
								<option value="bodyweight">🤸 Bodyweight</option>
								<option value="cardio">❤️ Cardio</option>
								<option value="hiit">🔥 HIIT</option>
								<option value="mobility">🧘 Mobility</option>
								<option value="stretching">🤸 Stretching</option>
								<option value="plyometrics">⚡ Plyometrics</option>
							</select>
						</div>
						
						<div class="form-group">
							<label for="exercise-add-equipment">Thiết bị</label>
							<select id="exercise-add-equipment" class="form-select">
								<option value="bodyweight">🤸 Bodyweight</option>
								<option value="barbell">🏋️ Barbell</option>
								<option value="dumbbell">🏋️ Dumbbell</option>
								<option value="machine">🔧 Machine</option>
								<option value="cable">🔗 Cable</option>
								<option value="weightedbodyweight">⚖️ Weighted Bodyweight</option>
								<option value="assistedbodyweight">🤝 Assisted Bodyweight</option>
								<option value="reponly">🔢 Rep Only</option>
								<option value="cardio">❤️ Cardio Equipment</option>
								<option value="duration">⏱️ Duration Based</option>
							</select>
						</div>
					</div>
					
					<div class="form-group">
						<label for="exercise-add-unit">Đơn vị đo</label>
						<select id="exercise-add-unit" class="form-select">
							<option value="kg">🏋️ Kilograms (kg)</option>
							<option value="lb">🏋️ Pounds (lb)</option>
							<option value="reps">🔢 Reps only</option>
							<option value="minute">⏱️ Minutes</option>
							<option value="second">⏱️ Seconds</option>
						</select>
					</div>
					
					<div class="form-group">
						<label for="exercise-add-description">Mô tả (tùy chọn)</label>
						<textarea id="exercise-add-description" class="form-input" rows="2" placeholder="Hướng dẫn ngắn gọn về cách thực hiện..."></textarea>
					</div>
					
					<!-- Image section -->
					<div class="form-group">
						<label>Hình ảnh bài tập (tùy chọn)</label>
						<div class="image-input-tabs">
							<button type="button" class="tab-btn active" onclick="app.switchImageTab('add', 'upload', event)">📤 Upload</button>
							<button type="button" class="tab-btn" onclick="app.switchImageTab('add', 'url', event)">🔗 URL</button>
						</div>
						
						<!-- Upload tab -->
						<div id="exercise-add-upload-tab" class="image-tab active">
							<div class="image-upload-area">
								<input type="file" id="exercise-add-image" accept="image/*" onchange="app.previewExerciseImage(event, 'add')" style="display:none;">
								<div id="exercise-add-image-preview" class="image-preview-container">
									<label for="exercise-add-image" class="upload-placeholder">
										<span class="upload-icon">📷</span>
										<span class="upload-text">Click để tải ảnh lên</span>
									</label>
								</div>
							</div>
						</div>
						
						<!-- URL tab -->
						<div id="exercise-add-url-tab" class="image-tab" style="display:none;">
							<div class="url-input-wrapper">
								<input type="url" 
									   id="exercise-add-image-url" 
									   class="form-input" 
									   placeholder="https://example.com/image.jpg"
									   onpaste="app.handleImageUrlPaste(event, 'add')"
									   oninput="app.debounceImageUrlPreview('add')">
								<button type="button" class="btn btn-sm" onclick="app.previewImageFromUrl('add')">Preview</button>
							</div>
							<div id="exercise-add-url-preview" class="image-preview-container" style="margin-top: 10px; display:none;">
								<!-- URL preview will appear here -->
							</div>
						</div>
					</div>
				</form>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-secondary" onclick="app.closeAddExerciseModal()">Hủy</button>
				<button type="button" class="btn btn-primary" onclick="app.saveAddExercise()">➕ Thêm bài tập</button>
			</div>
		</div>
	</div>

    <!-- Exercise Edit Modal - FIXED -->
    <div class="modal" id="exercise-edit-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="exercise-edit-title">✏️ Chỉnh sửa bài tập</h3>
                <button class="modal-close" onclick="app.closeEditExerciseModal()">✕</button>
            </div>
            <div class="modal-body">
                <form id="exercise-edit-form">
                    <div class="form-group">
                        <label for="exercise-edit-name">Tên bài tập</label>
                        <input type="text" id="exercise-edit-name" class="form-input" required>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="exercise-edit-muscle">Nhóm cơ</label>
                            <select id="exercise-edit-muscle" class="form-select">
                                <option value="chest">💪 Ngực</option>
                                <option value="back">🔙 Lưng</option>
                                <option value="legs">🦵 Chân</option>
                                <option value="shoulders">💪 Vai</option>
                                <option value="arms">💪 Tay</option>
                                <option value="core">🔥 Bụng</option>
                                <option value="cardio">❤️ Cardio</option>
                                <option value="fullbody">🏃 Toàn thân</option>
                                <option value="olympic">🏋️ Olympic</option>
                                <option value="other">💪 Khác</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="exercise-edit-type">Loại bài tập</label>
                            <select id="exercise-edit-type" class="form-select">
                                <option value="strength">💪 Strength</option>
                                <option value="bodyweight">🤸 Bodyweight</option>
                                <option value="cardio">❤️ Cardio</option>
                                <option value="hiit">🔥 HIIT</option>
                                <option value="mobility">🧘 Mobility</option>
                                <option value="stretching">🤸 Stretching</option>
                                <option value="plyometrics">⚡ Plyometrics</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="exercise-edit-equipment">Thiết bị</label>
                            <select id="exercise-edit-equipment" class="form-select">
                                <option value="bodyweight">🤸 Bodyweight</option>
                                <option value="barbell">🏋️ Barbell</option>
                                <option value="dumbbell">🏋️ Dumbbell</option>
                                <option value="machine">🔧 Machine</option>
                                <option value="cable">🔗 Cable</option>
                                <option value="weightedbodyweight">⚖️ Weighted Bodyweight</option>
                                <option value="assistedbodyweight">🤝 Assisted Bodyweight</option>
                                <option value="reponly">🔢 Rep Only</option>
                                <option value="cardio">❤️ Cardio Equipment</option>
                                <option value="duration">⏱️ Duration Based</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="exercise-edit-unit">Đơn vị đo</label>
                            <select id="exercise-edit-unit" class="form-select">
                                <option value="kg">🏋️ Kilograms (kg)</option>
                                <option value="lb">🏋️ Pounds (lb)</option>
                                <option value="reps">🔢 Reps only</option>
                                <option value="minute">⏱️ Minutes</option>
                                <option value="second">⏱️ Seconds</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="exercise-edit-description">Mô tả</label>
                        <textarea id="exercise-edit-description" class="form-input" rows="2"></textarea>
                    </div>
					<div class="form-group">
						<label>Hình ảnh bài tập</label>
						<div class="image-input-tabs">
							<button type="button" class="tab-btn active" onclick="app.switchImageTab('edit', 'upload')">📤 Upload</button>
							<button type="button" class="tab-btn" onclick="app.switchImageTab('edit', 'url')">🔗 URL</button>
						</div>
						
						<!-- Upload tab -->
						<div id="exercise-edit-upload-tab" class="image-tab active">
							<div class="image-upload-area">
								<input type="file" id="exercise-edit-image" accept="image/*" onchange="app.previewExerciseImage(event, 'edit')" style="display:none;">
								<div id="exercise-edit-image-preview" class="image-preview-container">
									<label for="exercise-edit-image" class="upload-placeholder">
										<span class="upload-icon">📷</span>
										<span class="upload-text">Click để thay đổi ảnh</span>
									</label>
								</div>
							</div>
						</div>
						
						<!-- URL tab -->
						<div id="exercise-edit-url-tab" class="image-tab" style="display:none;">
							<div class="url-input-wrapper">
								<input type="url" 
									   id="exercise-edit-image-url" 
									   class="form-input" 
									   placeholder="https://example.com/image.jpg"
									   onpaste="app.handleImageUrlPaste(event, 'edit')"
									   oninput="app.debounceImageUrlPreview('edit')">
								<button type="button" class="btn btn-sm" onclick="app.previewImageFromUrl('edit')">Preview</button>
							</div>
							<div id="exercise-edit-url-preview" class="image-preview-container" style="margin-top: 10px; display:none;">
								<!-- URL preview will appear here -->
							</div>
						</div>
					</div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="app.closeEditExerciseModal()">Hủy</button>
                <button class="btn btn-primary" onclick="app.saveEditExercise()">💾 Lưu thay đổi</button>
            </div>
        </div>
    </div>

    <!-- Exercise History Modal -->
    <div class="modal" id="exercise-history-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="exercise-history-title">📊 Lịch sử bài tập</h3>
                <button class="modal-close" onclick="app.closeExerciseHistory()">✕</button>
            </div>
            <div class="modal-body">
                <div id="exercise-history-chart" class="chart-container" style="margin-bottom: 20px;">
                    <canvas id="exercise-progress-chart"></canvas>
                </div>
                <div id="exercise-history-list"></div>
            </div>
        </div>
    </div>

    <!-- Exercise Picker Modal (for replacement) -->
    <div class="modal" id="exercise-picker-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>🔄 Chọn bài tập thay thế</h3>
                <button class="modal-close" onclick="app.closeExercisePicker()">✕</button>
            </div>
            <div class="modal-body">
                <input type="search" id="exercise-picker-search" class="search-input" placeholder="🔍 Tìm kiếm bài tập...">
                <div id="exercise-picker-list"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="app.closeExercisePicker()">Hủy</button>
                <button class="btn btn-primary" id="confirm-ex-picker-btn">Xác nhận</button>
            </div>
        </div>
    </div>

    <!-- Workout Detail Modal -->
    <div class="modal" id="workout-detail-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>📊 Chi tiết Workout</h3>
                <button class="modal-close" onclick="document.getElementById('workout-detail-modal').classList.remove('active')">✕</button>
            </div>
            <div class="modal-body" id="workout-detail-content"></div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal" id="settings-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>⚙️ Cài đặt</h3>
                <button class="modal-close" onclick="app.closeSettings()">✕</button>
            </div>
            <div class="modal-body">
                <div class="settings-section">
                    <h4>🔔 Notifications</h4>
                    <label class="toggle-setting">
                        <input type="checkbox" id="enable-notifications" onchange="app.toggleNotifications()">
                        <span>Thông báo rest timer</span>
                    </label>
                    <label class="toggle-setting">
                        <input type="checkbox" id="enable-pr-notifications" onchange="app.togglePRNotifications()">
                        <span>Thông báo Personal Records</span>
                    </label>
                </div>
                
                <div class="settings-section">
                    <h4>⚖️ Units</h4>
                    <label class="radio-setting">
                        <input type="radio" name="weight-unit" value="kg" checked onchange="app.setWeightUnit('kg')">
                        <span>Kilograms (kg)</span>
                    </label>
                    <label class="radio-setting">
                        <input type="radio" name="weight-unit" value="lb" onchange="app.setWeightUnit('lb')">
                        <span>Pounds (lb)</span>
                    </label>
                </div>
                
                <div class="settings-section">
                    <h4>🎨 Theme</h4>
                    <label class="radio-setting">
                        <input type="radio" name="theme" value="auto" checked onchange="app.setTheme('auto')">
                        <span>Auto (System)</span>
                    </label>
                    <label class="radio-setting">
                        <input type="radio" name="theme" value="light" onchange="app.setTheme('light')">
                        <span>Light</span>
                    </label>
                    <label class="radio-setting">
                        <input type="radio" name="theme" value="dark" onchange="app.setTheme('dark')">
                        <span>Dark</span>
                    </label>
                </div>
                
                <div class="settings-section">
                    <h4>🤖 AI Features</h4>
                    <label class="toggle-setting">
                        <input type="checkbox" id="enable-ai-suggestions" checked onchange="app.toggleAISuggestions()">
                        <span>AI Workout Suggestions</span>
                    </label>
                    <label class="toggle-setting">
                        <input type="checkbox" id="enable-form-checks" checked onchange="app.toggleFormChecks()">
                        <span>AI Form Checks</span>
                    </label>
                </div>
            </div>
        </div>
    </div>

    <!-- Backend Settings Modal -->
    <div class="modal" id="backend-settings-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>☁️ Sync Settings</h3>
                <button class="modal-close" onclick="app.closeBackendSettings()">✕</button>
            </div>
            <div class="modal-body">
                <div class="settings-section">
                    <h4>Storage Provider</h4>
                    <label class="radio-setting">
                        <input type="radio" name="provider" value="local" checked onchange="app.toggleProviderConfig('local')">
                        <span>Local Storage Only</span>
                    </label>
                    <label class="radio-setting">
                        <input type="radio" name="provider" value="nas" onchange="app.toggleProviderConfig('nas')">
                        <span>Synology NAS</span>
                    </label>
                    <label class="radio-setting">
                        <input type="radio" name="provider" value="onedrive" onchange="app.toggleProviderConfig('onedrive')">
                        <span>OneDrive</span>
                    </label>
                </div>
                <div id="nas-config" class="provider-config" style="display:none;">
                    <h4>NAS Configuration</h4>
                    <div class="form-group">
                        <label>NAS URL</label>
                        <input type="text" class="form-input" placeholder="http://192.168.1.100:5000" id="nas-url">
                    </div>
                    <div class="form-group">
                        <label>Username</label>
                        <input type="text" class="form-input" placeholder="Username" id="nas-username">
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" class="form-input" placeholder="Password" id="nas-password">
                    </div>
                </div>
                <div id="onedrive-config" class="provider-config" style="display:none;">
                    <h4>OneDrive Configuration</h4>
                    <div class="onedrive-status" id="onedrive-status">
                        <p>Not connected</p>
                    </div>
                    <button class="btn btn-primary" onclick="app.authenticateOneDrive()">
                        Connect OneDrive
                    </button>
                </div>
                <div class="sync-status">
                    <h4>Sync Status</h4>
                    <div id="sync-status-info">
                        <p>Last sync: <span id="last-sync">Never</span></p>
                        <p>Status: <span id="sync-status-text">Not configured</span></p>
                    </div>
                    <button class="btn btn-secondary" onclick="app.manualSync()">Sync Now</button>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="app.closeBackendSettings()">Cancel</button>
                <button class="btn btn-primary" onclick="app.saveBackendSettings()">Save</button>
            </div>
        </div>
    </div>

    <!-- Rest Timer -->
    <div class="rest-timer" id="rest-timer">
        <div class="rest-timer-content">
            <div class="rest-timer-label">Thời gian nghỉ</div>
            <div class="rest-timer-time" id="rest-time">02:00</div>
            <div class="rest-timer-actions">
                <button class="rest-timer-btn" onclick="app.skipRest()">Bỏ qua</button>
                <button class="rest-timer-btn" onclick="app.addRestTime(30)">+30s</button>
            </div>
        </div>
    </div>

    <!-- PR Notification -->
    <div class="pr-notification" id="pr-notification" style="display:none;">
        <div class="pr-content">
            <span class="pr-icon">🏆</span>
            <span class="pr-text">Personal Record!</span>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toast-container"></div>

    <!-- Context Menu for units -->
    <div id="unit-context-menu" class="context-menu" style="display:none;position:absolute;z-index:1200;"></div>

    <!-- Main JS -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="js/analytics.js"></script>
    <script src="js/backend.js"></script>
    <script src="js/ai.js"></script>
    <script src="js/app.js"></script>

    <!-- PWA & Service Worker, Install Banner, Online/Offline, New Version Notify -->
    <script>
        if ('serviceWorker' in navigator) {
            (location.protocol.startsWith('http') && 'serviceWorker' in navigator) && navigator.serviceWorker.register('/service-worker.js')
                .then(registration => {
                    console.log('Service Worker registered');
                    registration.addEventListener('updatefound', () => {
                        const newWorker = registration.installing;
                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                app.showToast('New version available! Refresh to update.', 'info');
                            }
                        });
                    });
                })
                .catch(err => console.error('Service Worker registration failed:', err));
        }

        // Install PWA
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('install-banner').style.display = 'flex';
        });

        document.getElementById('install-btn').addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                if (outcome === 'accepted') {
                    console.log('PWA installed');
                }
                deferredPrompt = null;
                hideInstallBanner();
            }
        });

        function hideInstallBanner() {
            document.getElementById('install-banner').style.display = 'none';
        }

        // Handle offline/online status
        window.addEventListener('online', () => {
            document.getElementById('offline-indicator').style.display = 'none';
            app.showToast('Back online!', 'success');
            if (app.backend) {
                app.backend.processSyncQueue();
            }
        });

        window.addEventListener('offline', () => {
            document.getElementById('offline-indicator').style.display = 'flex';
            app.showToast('Bạn đang offline', 'warning');
        });

        // Global click handler for menus
        document.addEventListener('click', function (e) {
            document.querySelectorAll('.exercise-menu').forEach(menu => {
                if (!menu.contains(e.target) && !e.target.classList.contains('btn-ex-action') && !e.target.classList.contains('menu-icon')) {
                    menu.style.display = 'none';
                }
            });
        });
    </script>

<!-- ===== FULLFIX r4 inject start ===== -->

<script defer>
// --- wger client (minimal) ---
(function(global){
  const WGER_API = (global.WGER_API_BASE || 'https://wger.de/api/v2');
  const DEFAULT_LANG_ID = (global.WGER_LANG_ID || 2);
  const PAGE_SIZE = 20;
  function stripHtml(html){ if(!html) return ''; const d=document.createElement('div'); d.innerHTML=html; return d.textContent||d.innerText||''; }
  async function fetchJSON(url){ const r=await fetch(url); if(!r.ok) throw new Error(`WGER request failed ${r.status}: ${url}`); return r.json(); }
  async function listCategories(){ return (await fetchJSON(`${WGER_API}/exercisecategory/?limit=50`)).results; }
  async function listEquipment(){ return (await fetchJSON(`${WGER_API}/equipment/?limit=50`)).results; }
  async function pageExerciseInfo({offset=0, limit=PAGE_SIZE}={}){ return fetchJSON(`${WGER_API}/exerciseinfo/?limit=${limit}&offset=${offset}`); }
  async function searchExercises({q='', categoryId=null, equipmentId=null, page=1}){
    const offset=(page-1)*PAGE_SIZE; const data=await pageExerciseInfo({offset,limit:PAGE_SIZE}); const items=data.results||[];
    const filtered=items.filter(item=>{
      if(categoryId && item.category?.id!==Number(categoryId))return false;
      if(equipmentId && !item.equipment?.some(e=>e.id===Number(equipmentId)))return false;
      if(!q) return true; const t=(item.translations||[]).find(t=>t.language===Number(DEFAULT_LANG_ID))||item.translations?.[0];
      const hay=(t?.name||'').toLowerCase()+' '+(stripHtml(t?.description||'').toLowerCase()); return hay.includes(q.toLowerCase());
    });
    return {page, pageSize: PAGE_SIZE, total: data.count, items: filtered};
  }
  function pickTranslation(item, langId=DEFAULT_LANG_ID){ const tr=item.translations||[]; let t=tr.find(x=>x.language===Number(langId)); if(!t) t=tr.find(x=>x.language===2)||tr[0]||null; return t; }
  function mapToLocalExercise(item,{langId=DEFAULT_LANG_ID}={}){
    const t=pickTranslation(item,langId); const name=t?.name||`Exercise #${item.id}`; const instructionsHTML=t?.description||''; const categoryName=item.category?.name||'';
    const muscles=(item.muscles||[]).map(m=>m.name_en||m.name); const muscles_secondary=(item.muscles_secondary||[]).map(m=>m.name_en||m.name);
    const equipment=(item.equipment||[]).map(e=>e.name); const images=(item.images||[]).map(img=>img.image); const license=item.license?.short_name||''; const license_url=item.license?.url||'';
    return { id:`wger:${item.id}`, name, category:categoryName, muscles, muscles_secondary, equipment, instructionsHTML, images, source:'wger', source_url:`${WGER_API}/exerciseinfo/${item.id}/`, license, license_url, license_author:item.license_author||'' };
  }
  global.Wger={listCategories,listEquipment,pageExerciseInfo,searchExercises,mapToLocalExercise,pickTranslation,constants:{WGER_API,DEFAULT_LANG_ID}};
})(window);
</script>


<script defer>
// --- wger UI + icon toolbar normalizer + file:// PWA guard ---
(function(global){
  // PWA guard for file://
  if (location.protocol === 'file:') {
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register = function(){
        console.warn('[fullfix] SW disabled on file://'); return Promise.reject(new Error('SW disabled on file://'));
      };
    }
  }

  // Normalize Template/Import/Export buttons to icon-only
  document.addEventListener('DOMContentLoaded', ()=>{
    const ICONS = { Template:'➕', Import:'📥', Export:'📤' };
    const sel = ['button[title]','[role="button"][title]','button[aria-label]','[data-tooltip]'];
    document.querySelectorAll(sel.join(',')).forEach(btn=>{
      const label = btn.getAttribute('title') || btn.getAttribute('aria-label') || btn.getAttribute('data-tooltip');
      if(!label || !ICONS[label]) return;
      btn.textContent = ICONS[label];
      btn.setAttribute('aria-label', label);
      btn.setAttribute('title', label);
      Object.assign(btn.style, { minWidth:'36px', width: btn.style.width || '36px', height: btn.style.height || '36px',
        display:'inline-flex', alignItems:'center', justifyContent:'center', fontSize:'18px', lineHeight:'1' });
    });
  });

  // WGER Picker
  function openWgerPicker(){
    const wrapper = document.createElement('div');
    wrapper.style.width = 'min(900px, 96vw)'; wrapper.style.maxHeight = '80vh'; wrapper.style.overflow = 'auto';
    renderSearchPanel(wrapper);
    if(global.app && typeof global.app.openModal === 'function'){ global.app.openModal(wrapper); } else { document.body.appendChild(wrapper); }
  }
  function renderSearchPanel(container){
    container.innerHTML = `
      <style>
        .wger-search { display:flex; gap:.5rem; margin-bottom:.5rem; }
        .wger-grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap:12px; }
        .wger-card { border:1px solid var(--border-color, #2a2e37); border-radius:12px; padding:12px; background:#111827; color:#e5e7eb; box-shadow:0 1px 2px rgba(0,0,0,.15); display:flex; flex-direction:column; gap:8px; }
        .wger-card-title { font-weight:600; }
        .wger-thumb { width:100%; height:150px; object-fit:contain; border-radius:8px; background:#0b1220; }
        .wger-card-ft { display:flex; align-items:center; justify-content:space-between; gap:8px; }
        .wger-card-meta { color:#9ca3af; font-size:.85rem; }
        .wger-license { font-size:.8rem; color:#9ca3af; }
        .wger-desc { max-height:140px; overflow:auto; font-size:.9rem; }
        .wger-empty { padding:24px; text-align:center; color:#94a3b8; }
        .btn { padding:.5rem .75rem; border-radius:10px; border:1px solid #374151; background:#1f2937; color:#e5e7eb; cursor:pointer; }
        .btn-primary { background:#2563eb; color:white; border-color:#1d4ed8; }
        .wger-pill { border:1px solid #374151; padding:.25rem .5rem; border-radius:9999px; background:#1f2937; cursor:pointer; font-size:.85rem; color:#e5e7eb; }
      </style>
      <div class="wger-search">
        <input id="wger-q" class="wger-input" placeholder="Tìm bài tập (en)..." style="flex:1; padding:.5rem .75rem; border:1px solid #374151; border-radius:10px; background:#0f172a; color:#e5e7eb;" />
        <button id="wger-btn-search" class="btn">Search</button>
      </div>
      <div class="wger-filters" style="display:flex; gap:.5rem; flex-wrap:wrap;">
        <select id="wger-filter-category" class="wger-pill"><option value="">All categories</option></select>
        <select id="wger-filter-equipment" class="wger-pill"><option value="">All equipment</option></select>
      </div>
      <div id="wger-results" class="wger-grid"></div>
      <div id="wger-more" style="margin-top:8px; display:flex; justify-content:center;">
        <button class="btn" id="wger-load-more">Load more</button>
      </div>
    `;

    Wger.listCategories().then(list=>{
      const sel = container.querySelector('#wger-filter-category');
      list.forEach(c=>{ const opt = document.createElement('option'); opt.value=c.id; opt.textContent=c.name; sel.appendChild(opt); });
    }).catch(console.warn);
    Wger.listEquipment().then(list=>{
      const sel = container.querySelector('#wger-filter-equipment');
      list.forEach(e=>{ const opt = document.createElement('option'); opt.value=e.id; opt.textContent=e.name; sel.appendChild(opt); });
    }).catch(console.warn);

    const state = { page:1, currentQuery:'', categoryId:null, equipmentId:null, busy:false };
    const doSearch = async (append=false)=>{
      if(state.busy) return; state.busy = true;
      try{
        if(!append){ container.querySelector('#wger-results').innerHTML=''; state.page = 1; }
        const res = await Wger.searchExercises({ q: state.currentQuery, categoryId: state.categoryId, equipmentId: state.equipmentId, page: state.page });
        const grid = container.querySelector('#wger-results');
        if(res.items.length === 0 && !append){
          grid.innerHTML = `<div class="wger-empty">Không tìm thấy kết quả trên trang này. Thử từ khóa khác hoặc bấm "Load more".</div>`;
        } else {
          res.items.forEach(item => {
            const ex = Wger.mapToLocalExercise(item, {});
            const card = document.createElement('div'); card.className='wger-card';
            card.innerHTML = `
              <div class="wger-card-hd">
                <div class="wger-card-title">${ex.name}</div>
                <div class="wger-card-meta">${ex.category} • ${(ex.equipment||[]).join(', ') || 'Bodyweight'}</div>
              </div>
              <div class="wger-card-body">
                ${ex.images?.[0] ? `<img class="wger-thumb" alt="${ex.name}" src="${ex.images[0]}" />` : ''}
                <div class="wger-desc">${ex.instructionsHTML || '<em>No description</em>'}</div>
              </div>
              <div class="wger-card-ft">
                <span class="wger-license">License: ${ex.license || '—'}</span>
                <button class="btn btn-primary">Import</button>
              </div>`;
            card.querySelector('.btn-primary').addEventListener('click', ()=>{
              try{
                if(global.app && typeof global.app.addExerciseToLibrary === 'function'){
                  global.app.addExerciseToLibrary(ex);
                  global.app.toast && global.app.toast(`Đã import "${ex.name}" từ WGER`);
                } else { alert('Imported (mock). Hãy kết nối với app.addExerciseToLibrary(ex).'); }
              }catch(e){ alert('Import failed: '+e.message); }
            });
            grid.appendChild(card);
          });
        }
        state.page++;
      } finally { state.busy = false; }
    };
    container.querySelector('#wger-btn-search').addEventListener('click', ()=>{ state.currentQuery = container.querySelector('#wger-q').value.trim(); doSearch(false); });
    container.querySelector('#wger-load-more').addEventListener('click', ()=> doSearch(true));
    container.querySelector('#wger-filter-category').addEventListener('change', e=>{ state.categoryId = e.target.value || null; doSearch(false); });
    container.querySelector('#wger-filter-equipment').addEventListener('change', e=>{ state.equipmentId = e.target.value || null; doSearch(false); });
    doSearch(false);
  }

  // Insert WGER button beside common "Add exercise" anchors
  document.addEventListener('DOMContentLoaded', ()=>{
    const anchor = document.querySelector('[data-add-exercise-anchor]') || document.querySelector('#add-exercise') || document.querySelector('.add-exercise');
    if(anchor && !anchor.querySelector('.btn-wger')){
      const btn = document.createElement('button');
      btn.className='btn btn-wger'; btn.style.marginLeft='.5rem'; btn.title='Import bài tập từ WGER'; btn.innerHTML='🧰 WGER';
      btn.addEventListener('click', openWgerPicker);
      anchor.appendChild(btn);
    }
  });
})(window);
</script>

<!-- ===== FULLFIX r4 inject end ===== -->
</body>
</html>