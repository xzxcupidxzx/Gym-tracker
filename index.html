<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Gym Tracker - Qu·∫£n l√Ω t·∫≠p luy·ªán th√¥ng minh</title>
    <meta name="description" content="·ª®ng d·ª•ng theo d√µi v√† qu·∫£n l√Ω t·∫≠p luy·ªán gym v·ªõi AI">
    <meta name="theme-color" content="#4CAF50">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Gym Tracker">

    <!-- PWA -->
    <link rel="manifest" href="/manifest.json">
    <link rel="icon" type="image/x-icon" href="/icon/favicon.ico">
    <link rel="icon" type="image/png" sizes="96x96" href="/icon/Gym-favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/icon/Gym-192x192.png">
    <link rel="apple-touch-icon" href="/icon/Gym-apple-touch-icon.png">
    <link rel="stylesheet" href="css/main.css">
    
    <!-- Chart.js Preload (cho analytics) -->
	<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
</head>
<body>
    <audio id="sound-beep" src="sounds/beep.mp3" preload="auto"></audio>
    <audio id="sound-done" src="sounds/done.mp3" preload="auto"></audio>

    <!-- Install Banner -->
    <div id="install-banner" class="install-banner" style="display:none;">
        <div class="install-content">
            <span>üì± C√†i ƒë·∫∑t Gym Tracker ƒë·ªÉ d√πng offline</span>
            <button class="btn btn-primary btn-sm" id="install-btn">C√†i ƒë·∫∑t</button>
            <button class="btn-close" onclick="hideInstallBanner()">√ó</button>
        </div>
    </div>

    <!-- Offline Indicator -->
    <div id="offline-indicator" class="offline-indicator" style="display:none;">
        <span>üì° ƒêang offline</span>
    </div>

    <!-- Header -->
    <header class="app-header">
        <div class="container">
            <div class="header-content">
                <h1 class="app-title">üí™ Gym Tracker</h1>
                <div class="header-actions">
                    <button class="icon-btn" onclick="app.openBackendSettings()" title="Sync Settings">
                        <span id="sync-status">‚òÅÔ∏è</span>
                    </button>
                    <button class="icon-btn" onclick="app.openSettings()" title="Settings">‚öôÔ∏è</button>
                    <button class="menu-toggle" id="menu-toggle" aria-label="Toggle menu">
                        <span></span><span></span><span></span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Navigation -->
    <nav class="app-nav" id="app-nav">
        <div class="container">
            <div class="nav-links">
                <a href="#home" class="nav-link active" data-page="home">
                    <span class="nav-icon">üè†</span>
                    <span class="nav-text">Trang ch·ªß</span>
                </a>
                <a href="#templates" class="nav-link" data-page="templates">
                    <span class="nav-icon">üìã</span>
                    <span class="nav-text">Templates</span>
                </a>
                <a href="#exercises" class="nav-link" data-page="exercises">
                    <span class="nav-icon">üèãÔ∏è</span>
                    <span class="nav-text">B√†i t·∫≠p</span>
                </a>
                <a href="#analytics" class="nav-link" data-page="analytics">
                    <span class="nav-icon">üìä</span>
                    <span class="nav-text">Analytics</span>
                </a>
                <a href="#history" class="nav-link" data-page="history">
                    <span class="nav-icon">üìÖ</span>
                    <span class="nav-text">L·ªãch s·ª≠</span>
                </a>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="app-main">
        <div class="container">
            <!-- Home Page -->
            <section id="home-page" class="page active">
                <div id="ai-suggestion-banner" class="ai-suggestion-banner" style="display:none;">
                    <div class="ai-content">
                        <span class="ai-icon">ü§ñ</span>
                        <div class="ai-text">
                            <strong>AI Suggestion</strong>
                            <p id="ai-suggestion-text"></p>
                        </div>
                        <button class="btn btn-primary btn-sm" onclick="app.acceptAISuggestion()">S·ª≠ d·ª•ng</button>
                    </div>
                </div>
                <div class="stats-grid">
                    <div class="stat-card"><div class="stat-icon">üèãÔ∏è</div><div class="stat-content"><div class="stat-value" id="total-workouts">0</div><div class="stat-label">Bu·ªïi t·∫≠p</div></div></div>
                    <div class="stat-card"><div class="stat-icon">üìã</div><div class="stat-content"><div class="stat-value" id="total-templates">0</div><div class="stat-label">Templates</div></div></div>
                    <div class="stat-card"><div class="stat-icon">üî•</div><div class="stat-content"><div class="stat-value" id="this-week">0</div><div class="stat-label">Tu·∫ßn n√†y</div></div></div>
                    <div class="stat-card"><div class="stat-icon">üí™</div><div class="stat-content"><div class="stat-value" id="total-volume">0</div><div class="stat-label">T·ªïng KG</div></div></div>
                </div>
                <div class="quick-actions">
                    <button class="quick-action-btn primary" onclick="app.startQuickWorkout()">
                        <span class="btn-icon">üöÄ</span>
                        <span class="btn-text">B·∫Øt ƒë·∫ßu t·∫≠p</span>
                    </button>
                    <button class="quick-action-btn" onclick="app.getAIWorkoutSuggestion()">
                        <span class="btn-icon">ü§ñ</span>
                        <span class="btn-text">AI Suggest</span>
                    </button>
                    <button class="quick-action-btn" onclick="app.createTemplate()">
                        <span class="btn-icon">‚ûï</span>
                        <span class="btn-text">T·∫°o template</span>
                    </button>
                </div>
                <div class="section">
                    <div class="section-header">
                        <h2 class="section-title">Templates g·∫ßn ƒë√¢y</h2>
                        <a href="#templates" class="section-link" onclick="app.loadPage('templates')">Xem t·∫•t c·∫£ ‚Üí</a>
                    </div>
                    <div class="templates-grid" id="recent-templates"></div>
                </div>
                <div class="section">
                    <div class="section-header">
                        <h2 class="section-title">üèÜ Personal Records</h2>
                        <a href="#analytics" class="section-link" onclick="app.loadPage('analytics')">Xem analytics ‚Üí</a>
                    </div>
                    <div id="recent-prs" class="pr-list"></div>
                </div>
            </section>

            <!-- Templates Page -->
            <section id="templates-page" class="page">
                <div class="page-header">
                    <h2 class="page-title">üìã Templates</h2>
                    <div class="header-actions">
                        <button class="btn btn-primary" onclick="app.createTemplate()">
                            <span class="btn-icon">‚ûï</span>T·∫°o template
                        </button>
                        <button class="btn btn-secondary" onclick="document.getElementById('import-template-file').click()">
                            <span class="btn-icon">üì•</span>Import
                        </button>
                        <button class="btn btn-secondary" onclick="app.exportTemplates()">
                            <span class="btn-icon">üì§</span>Export
                        </button>
                    </div>
                </div>
                
                <div class="filters">
                    <input type="search" class="search-input" id="template-search" placeholder="üîç T√¨m ki·∫øm templates...">
                    <select class="filter-select" id="template-filter">
                        <option value="">T·∫•t c·∫£ ƒë·ªô kh√≥</option>
                        <option value="beginner">üå± Ng∆∞·ªùi m·ªõi</option>
                        <option value="intermediate">‚ö° Trung c·∫•p</option>
                        <option value="advanced">üî• N√¢ng cao</option>
                    </select>
                </div>
                
                <input type="file" id="import-template-file" accept=".json" style="display:none;" onchange="app.importTemplates(event)">
                <div class="templates-grid" id="all-templates"></div>
            </section>

            <!-- Exercises Page - FIXED -->
            <section id="exercises-page" class="page">
                <div class="page-header">
                    <h2 class="page-title">üèãÔ∏è Qu·∫£n l√Ω b√†i t·∫≠p</h2>
                    <div class="header-actions">
                        <button class="btn btn-primary" onclick="app.openAddExerciseModal()">
                            <span class="btn-icon">‚ûï</span>Th√™m b√†i t·∫≠p
                        </button>
                        <button class="btn btn-secondary" onclick="document.getElementById('import-exercise-file').click()">
                            <span class="btn-icon">üì•</span>Import
                        </button>
                        <button class="btn btn-secondary" onclick="app.exportExercises()">
                            <span class="btn-icon">üì§</span>Export
                        </button>
                    </div>
                </div>
                
                <!-- Exercise Filters -->
                <div class="filters">
                    <input type="search" class="search-input" id="exercise-search" placeholder="üîç T√¨m ki·∫øm b√†i t·∫≠p...">
                    <select class="filter-select" id="muscle-filter">
                        <option value="">T·∫•t c·∫£ nh√≥m c∆°</option>
                        <option value="chest">üí™ Ng·ª±c</option>
                        <option value="back">üîô L∆∞ng</option>
                        <option value="legs">ü¶µ Ch√¢n</option>
                        <option value="shoulders">üí™ Vai</option>
                        <option value="arms">üí™ Tay</option>
                        <option value="core">üî• B·ª•ng</option>
                        <option value="cardio">‚ù§Ô∏è Cardio</option>
                        <option value="fullbody">üèÉ To√†n th√¢n</option>
                        <option value="olympic">üèãÔ∏è Olympic</option>
                        <option value="other">üí™ Kh√°c</option>
                    </select>
                    <select class="filter-select" id="equipment-filter">
                        <option value="">T·∫•t c·∫£ thi·∫øt b·ªã</option>
                        <option value="bodyweight">Bodyweight</option>
                        <option value="barbell">Barbell</option>
                        <option value="dumbbell">Dumbbell</option>
                        <option value="machine">Machine</option>
                        <option value="cable">Cable</option>
                    </select>
                </div>
                
                <input type="file" id="import-exercise-file" accept=".json" style="display:none;" onchange="app.importExercises(event)">
                
                <!-- Exercise Stats -->
                <div class="exercise-stats" style="margin-bottom: 20px;">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon">üèãÔ∏è</div>
                            <div class="stat-content">
                                <div class="stat-value" id="total-exercises-count">0</div>
                                <div class="stat-label">T·ªïng b√†i t·∫≠p</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">üí™</div>
                            <div class="stat-content">
                                <div class="stat-value" id="strength-exercises-count">0</div>
                                <div class="stat-label">Strength</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">‚ù§Ô∏è</div>
                            <div class="stat-content">
                                <div class="stat-value" id="cardio-exercises-count">0</div>
                                <div class="stat-label">Cardio</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon">ü§∏</div>
                            <div class="stat-content">
                                <div class="stat-value" id="bodyweight-exercises-count">0</div>
                                <div class="stat-label">Bodyweight</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Exercise Grid -->
                <div class="exercises-grid" id="all-exercises"></div>
            </section>

            <!-- Analytics Page - UPDATED -->
            <section id="analytics-page" class="page">
                <div class="page-header">
                    <h2 class="page-title">üìä Analytics & Insights</h2>
                    <div class="header-actions">
                        <button class="btn btn-secondary" onclick="app.generateReport()">
                            <span class="btn-icon">üìÑ</span>Generate Report
                        </button>
                        <button class="btn btn-secondary" onclick="app.refreshAnalytics()">
                            <span class="btn-icon">üîÑ</span>Refresh
                        </button>
                    </div>
                </div>
                
                <div class="time-range-selector">
                    <button class="time-btn active" data-range="week">Week</button>
                    <button class="time-btn" data-range="month">Month</button>
                    <button class="time-btn" data-range="quarter">Quarter</button>
                    <button class="time-btn" data-range="year">Year</button>
                </div>
                
                <div class="analytics-grid">
                    <div class="chart-container">
                        <h3>üìà Volume Progression</h3>
                        <div class="chart-wrapper">
                            <canvas id="volume-chart"></canvas>
                        </div>
                    </div>
                    
                    <div class="chart-container">
                        <h3>üéØ Muscle Distribution</h3>
                        <div class="chart-wrapper">
                            <canvas id="muscle-distribution-chart"></canvas>
                        </div>
                    </div>
                    
                    <div class="chart-container">
                        <h3>üìÖ Workout Frequency</h3>
                        <div class="chart-wrapper">
                            <canvas id="frequency-chart"></canvas>
                        </div>
                    </div>
                    
                    <div class="chart-container">
                        <h3>üèÜ Personal Records</h3>
                        <div class="chart-wrapper">
                            <canvas id="pr-chart"></canvas>
                        </div>
                    </div>
                    
                    <div class="chart-container">
                        <h3>üí™ Strength Standards</h3>
                        <div class="chart-wrapper">
                            <canvas id="strength-chart"></canvas>
                        </div>
                    </div>
                    
                    <div class="chart-container">
                        <h3>üîÆ Progress Prediction</h3>
                        <div class="chart-wrapper">
                            <canvas id="prediction-chart"></canvas>
                        </div>
                    </div>
                </div>
                
                <!-- Analytics Summary -->
                <div class="analytics-summary">
                    <div class="summary-card">
                        <h4>üéØ This Week</h4>
                        <div id="weekly-summary" class="summary-content">
                            <div class="summary-stat">
                                <span class="stat-label">Workouts:</span>
                                <span class="stat-value" id="weekly-workouts">-</span>
                            </div>
                            <div class="summary-stat">
                                <span class="stat-label">Volume:</span>
                                <span class="stat-value" id="weekly-volume">-</span>
                            </div>
                            <div class="summary-stat">
                                <span class="stat-label">PRs:</span>
                                <span class="stat-value" id="weekly-prs">-</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="summary-card">
                        <h4>üìä All Time</h4>
                        <div id="alltime-summary" class="summary-content">
                            <div class="summary-stat">
                                <span class="stat-label">Total Workouts:</span>
                                <span class="stat-value" id="total-workouts-analytics">-</span>
                            </div>
                            <div class="summary-stat">
                                <span class="stat-label">Total Volume:</span>
                                <span class="stat-value" id="total-volume-analytics">-</span>
                            </div>
                            <div class="summary-stat">
                                <span class="stat-label">Avg/Week:</span>
                                <span class="stat-value" id="avg-workouts-week">-</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="insights-section">
                    <h3>ü§ñ AI Insights</h3>
                    <div id="ai-insights" class="insights-grid">
                        <div class="insight-card">
                            <div class="insight-icon">üí°</div>
                            <div class="insight-content">
                                <h4>Smart Recommendations</h4>
                                <p>AI insights will appear here based on your workout data and progress patterns.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- History Page -->
            <section id="history-page" class="page">
                <div class="page-header">
                    <h2 class="page-title">üìÖ L·ªãch s·ª≠ t·∫≠p luy·ªán</h2>
                    <div class="header-actions">
                        <input type="file" id="import-file" accept=".json" style="display:none;" onchange="app.handleImportFile(event)">
                        <button class="btn btn-secondary" onclick="document.getElementById('import-file').click()"><span class="btn-icon">üì•</span>Import</button>
                        <button class="btn btn-secondary" onclick="app.exportData()"><span class="btn-icon">üì§</span>Export</button>
                    </div>
                </div>
                <div class="view-toggle">
                    <button class="view-btn active" data-view="list">List</button>
                    <button class="view-btn" data-view="calendar">Calendar</button>
                </div>
                <div class="history-list" id="workout-history"></div>
                <div class="calendar-view" id="workout-calendar" style="display:none;"></div>
            </section>
        </div>
    </main>

    <!-- Workout Modal -->
    <div class="modal" id="workout-modal">
        <div class="modal-content workout-modal">
            <div class="modal-header">
                <h3 id="workout-title">Workout</h3>
                <div id="workout-timer-box">
                    <span class="timer-icon">‚è±Ô∏è</span>
                    <span class="timer-text" id="workout-timer">00:00</span>
                </div>
                <button class="modal-close" onclick="app.closeWorkout()">‚úï</button>
            </div>
            <div class="modal-body">
                <div class="workout-exercises" id="workout-exercises"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="app.pauseWorkout()">T·∫°m d·ª´ng</button>
                <button class="btn btn-primary" onclick="app.finishWorkout()">Ho√†n th√†nh</button>
            </div>
        </div>
    </div>

    <!-- Template Form Modal -->
    <div class="modal" id="template-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="template-form-title">T·∫°o Template</h3>
                <button class="modal-close" onclick="app.closeTemplateForm()">‚úï</button>
            </div>
            <form id="template-form" class="modal-body">
                <div class="form-group">
                    <label for="template-name">T√™n template</label>
                    <input type="text" id="template-name" class="form-input" placeholder="VD: Push Day, Leg Day..." required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="template-level">ƒê·ªô kh√≥</label>
                        <select id="template-level" class="form-select">
                            <option value="">Ch·ªçn ƒë·ªô kh√≥</option>
                            <option value="beginner">üå± Ng∆∞·ªùi m·ªõi</option>
                            <option value="intermediate">‚ö° Trung c·∫•p</option>
                            <option value="advanced">üî• N√¢ng cao</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="template-duration">Th·ªùi gian (ph√∫t)</label>
                        <input type="number" id="template-duration" class="form-input" placeholder="60" min="15" max="180">
                    </div>
                </div>
                <div class="form-group">
                    <label>B√†i t·∫≠p</label>
                    <div class="selected-exercises" id="selected-exercises"></div>
                    <button type="button" class="btn btn-secondary btn-block" onclick="app.selectExercises()">‚ûï Th√™m b√†i t·∫≠p</button>
                </div>
            </form>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="app.closeTemplateForm()">H·ªßy</button>
                <button class="btn btn-primary" onclick="app.saveTemplate()">L∆∞u template</button>
            </div>
        </div>
    </div>

    <!-- Template Preview Modal -->
    <div class="modal" id="template-preview-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="template-preview-title">Template</h3>
                <button class="modal-close" onclick="app.closeTemplatePreview()">‚úï</button>
            </div>
            <div class="modal-body">
                <div id="template-preview-list"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="app.editTemplateFromPreview()">Edit</button>
                <button class="btn btn-primary" onclick="app.startWorkoutFromPreview()">Start Workout</button>
            </div>
        </div>
    </div>

    <!-- Exercise Selection Modal -->
    <div class="modal" id="exercise-select-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Ch·ªçn b√†i t·∫≠p</h3>
                <button class="modal-close" onclick="app.closeExerciseSelect()">‚úï</button>
            </div>
            <div class="modal-body">
                <input type="search" class="search-input" id="exercise-select-search" placeholder="üîç T√¨m ki·∫øm b√†i t·∫≠p...">
                <div class="exercise-select-list" id="exercise-select-list"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="app.closeExerciseSelect()">H·ªßy</button>
                <button class="btn btn-primary" onclick="app.confirmExerciseSelection()">X√°c nh·∫≠n</button>
            </div>
        </div>
    </div>

    <!-- Exercise Add Modal - FIXED -->
    <div class="modal" id="exercise-add-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>‚ûï Th√™m b√†i t·∫≠p m·ªõi</h3>
                <button class="modal-close" onclick="app.closeAddExerciseModal()">‚úï</button>
            </div>
            <div class="modal-body">
                <form id="exercise-add-form" onsubmit="event.preventDefault(); app.saveAddExercise();">
                    <div class="form-group">
                        <label for="exercise-add-name">T√™n b√†i t·∫≠p *</label>
                        <input type="text" id="exercise-add-name" class="form-input" placeholder="VD: Bench Press, Squat..." required>
                    </div>
                    
                    <div class="form-group">
                        <label>Nh√≥m c∆° *</label>
                        <div id="exercise-add-muscle-group" class="chip-group" style="margin-top:8px;">
                            <button type="button" class="chip-btn" data-value="chest">üí™ Ng·ª±c</button>
                            <button type="button" class="chip-btn" data-value="back">üîô L∆∞ng</button>
                            <button type="button" class="chip-btn" data-value="legs">ü¶µ Ch√¢n</button>
                            <button type="button" class="chip-btn" data-value="shoulders">üí™ Vai</button>
                            <button type="button" class="chip-btn" data-value="arms">üí™ Tay</button>
                            <button type="button" class="chip-btn" data-value="core">üî• B·ª•ng</button>
                            <button type="button" class="chip-btn" data-value="cardio">‚ù§Ô∏è Cardio</button>
                            <button type="button" class="chip-btn" data-value="fullbody">üèÉ To√†n th√¢n</button>
                            <button type="button" class="chip-btn" data-value="olympic">üèãÔ∏è Olympic</button>
                            <button type="button" class="chip-btn" data-value="other">üí™ Kh√°c</button>
                        </div>
                        <input type="hidden" id="exercise-add-muscle" required>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="exercise-add-type">Lo·∫°i b√†i t·∫≠p</label>
                            <select id="exercise-add-type" class="form-select">
                                <option value="strength">üí™ Strength</option>
                                <option value="bodyweight">ü§∏ Bodyweight</option>
                                <option value="cardio">‚ù§Ô∏è Cardio</option>
                                <option value="hiit">üî• HIIT</option>
                                <option value="mobility">üßò Mobility</option>
                                <option value="stretching">ü§∏ Stretching</option>
                                <option value="plyometrics">‚ö° Plyometrics</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="exercise-add-equipment">Thi·∫øt b·ªã</label>
                            <select id="exercise-add-equipment" class="form-select">
                                <option value="bodyweight">ü§∏ Bodyweight</option>
                                <option value="barbell">üèãÔ∏è Barbell</option>
                                <option value="dumbbell">üèãÔ∏è Dumbbell</option>
                                <option value="machine">üîß Machine</option>
                                <option value="cable">üîó Cable</option>
                                <option value="weightedbodyweight">‚öñÔ∏è Weighted Bodyweight</option>
                                <option value="assistedbodyweight">ü§ù Assisted Bodyweight</option>
                                <option value="reponly">üî¢ Rep Only</option>
                                <option value="cardio">‚ù§Ô∏è Cardio Equipment</option>
                                <option value="duration">‚è±Ô∏è Duration Based</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="exercise-add-unit">ƒê∆°n v·ªã ƒëo</label>
                        <select id="exercise-add-unit" class="form-select">
                            <option value="kg">üèãÔ∏è Kilograms (kg)</option>
                            <option value="lb">üèãÔ∏è Pounds (lb)</option>
                            <option value="reps">üî¢ Reps only</option>
                            <option value="minute">‚è±Ô∏è Minutes</option>
                            <option value="second">‚è±Ô∏è Seconds</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="exercise-add-description">M√¥ t·∫£ (t√πy ch·ªçn)</label>
                        <textarea id="exercise-add-description" class="form-input" rows="2" placeholder="H∆∞·ªõng d·∫´n ng·∫Øn g·ªçn v·ªÅ c√°ch th·ª±c hi·ªán..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="app.closeAddExerciseModal()">H·ªßy</button>
                <button class="btn btn-primary" onclick="app.saveAddExercise()">‚ûï Th√™m b√†i t·∫≠p</button>
            </div>
        </div>
    </div>

    <!-- Exercise Edit Modal - FIXED -->
    <div class="modal" id="exercise-edit-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="exercise-edit-title">‚úèÔ∏è Ch·ªânh s·ª≠a b√†i t·∫≠p</h3>
                <button class="modal-close" onclick="app.closeEditExerciseModal()">‚úï</button>
            </div>
            <div class="modal-body">
                <form id="exercise-edit-form">
                    <div class="form-group">
                        <label for="exercise-edit-name">T√™n b√†i t·∫≠p</label>
                        <input type="text" id="exercise-edit-name" class="form-input" required>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="exercise-edit-muscle">Nh√≥m c∆°</label>
                            <select id="exercise-edit-muscle" class="form-select">
                                <option value="chest">üí™ Ng·ª±c</option>
                                <option value="back">üîô L∆∞ng</option>
                                <option value="legs">ü¶µ Ch√¢n</option>
                                <option value="shoulders">üí™ Vai</option>
                                <option value="arms">üí™ Tay</option>
                                <option value="core">üî• B·ª•ng</option>
                                <option value="cardio">‚ù§Ô∏è Cardio</option>
                                <option value="fullbody">üèÉ To√†n th√¢n</option>
                                <option value="olympic">üèãÔ∏è Olympic</option>
                                <option value="other">üí™ Kh√°c</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="exercise-edit-type">Lo·∫°i b√†i t·∫≠p</label>
                            <select id="exercise-edit-type" class="form-select">
                                <option value="strength">üí™ Strength</option>
                                <option value="bodyweight">ü§∏ Bodyweight</option>
                                <option value="cardio">‚ù§Ô∏è Cardio</option>
                                <option value="hiit">üî• HIIT</option>
                                <option value="mobility">üßò Mobility</option>
                                <option value="stretching">ü§∏ Stretching</option>
                                <option value="plyometrics">‚ö° Plyometrics</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="exercise-edit-equipment">Thi·∫øt b·ªã</label>
                            <select id="exercise-edit-equipment" class="form-select">
                                <option value="bodyweight">ü§∏ Bodyweight</option>
                                <option value="barbell">üèãÔ∏è Barbell</option>
                                <option value="dumbbell">üèãÔ∏è Dumbbell</option>
                                <option value="machine">üîß Machine</option>
                                <option value="cable">üîó Cable</option>
                                <option value="weightedbodyweight">‚öñÔ∏è Weighted Bodyweight</option>
                                <option value="assistedbodyweight">ü§ù Assisted Bodyweight</option>
                                <option value="reponly">üî¢ Rep Only</option>
                                <option value="cardio">‚ù§Ô∏è Cardio Equipment</option>
                                <option value="duration">‚è±Ô∏è Duration Based</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="exercise-edit-unit">ƒê∆°n v·ªã ƒëo</label>
                            <select id="exercise-edit-unit" class="form-select">
                                <option value="kg">üèãÔ∏è Kilograms (kg)</option>
                                <option value="lb">üèãÔ∏è Pounds (lb)</option>
                                <option value="reps">üî¢ Reps only</option>
                                <option value="minute">‚è±Ô∏è Minutes</option>
                                <option value="second">‚è±Ô∏è Seconds</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="exercise-edit-description">M√¥ t·∫£</label>
                        <textarea id="exercise-edit-description" class="form-input" rows="2"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="app.closeEditExerciseModal()">H·ªßy</button>
                <button class="btn btn-primary" onclick="app.saveEditExercise()">üíæ L∆∞u thay ƒë·ªïi</button>
            </div>
        </div>
    </div>

    <!-- Exercise History Modal -->
    <div class="modal" id="exercise-history-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="exercise-history-title">üìä L·ªãch s·ª≠ b√†i t·∫≠p</h3>
                <button class="modal-close" onclick="app.closeExerciseHistory()">‚úï</button>
            </div>
            <div class="modal-body">
                <div id="exercise-history-chart" class="chart-container" style="margin-bottom: 20px;">
                    <canvas id="exercise-progress-chart"></canvas>
                </div>
                <div id="exercise-history-list"></div>
            </div>
        </div>
    </div>

    <!-- Exercise Picker Modal (for replacement) -->
    <div class="modal" id="exercise-picker-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üîÑ Ch·ªçn b√†i t·∫≠p thay th·∫ø</h3>
                <button class="modal-close" onclick="app.closeExercisePicker()">‚úï</button>
            </div>
            <div class="modal-body">
                <input type="search" class="search-input" placeholder="üîç T√¨m ki·∫øm b√†i t·∫≠p thay th·∫ø...">
                <div id="exercise-picker-list"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="app.closeExercisePicker()">H·ªßy</button>
                <button class="btn btn-primary" id="confirm-ex-picker-btn">X√°c nh·∫≠n</button>
            </div>
        </div>
    </div>

    <!-- Workout Detail Modal -->
    <div class="modal" id="workout-detail-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üìä Chi ti·∫øt Workout</h3>
                <button class="modal-close" onclick="document.getElementById('workout-detail-modal').classList.remove('active')">‚úï</button>
            </div>
            <div class="modal-body" id="workout-detail-content"></div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal" id="settings-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>‚öôÔ∏è C√†i ƒë·∫∑t</h3>
                <button class="modal-close" onclick="app.closeSettings()">‚úï</button>
            </div>
            <div class="modal-body">
                <div class="settings-section">
                    <h4>üîî Notifications</h4>
                    <label class="toggle-setting">
                        <input type="checkbox" id="enable-notifications" onchange="app.toggleNotifications()">
                        <span>Th√¥ng b√°o rest timer</span>
                    </label>
                    <label class="toggle-setting">
                        <input type="checkbox" id="enable-pr-notifications" onchange="app.togglePRNotifications()">
                        <span>Th√¥ng b√°o Personal Records</span>
                    </label>
                </div>
                
                <div class="settings-section">
                    <h4>‚öñÔ∏è Units</h4>
                    <label class="radio-setting">
                        <input type="radio" name="weight-unit" value="kg" checked onchange="app.setWeightUnit('kg')">
                        <span>Kilograms (kg)</span>
                    </label>
                    <label class="radio-setting">
                        <input type="radio" name="weight-unit" value="lb" onchange="app.setWeightUnit('lb')">
                        <span>Pounds (lb)</span>
                    </label>
                </div>
                
                <div class="settings-section">
                    <h4>üé® Theme</h4>
                    <label class="radio-setting">
                        <input type="radio" name="theme" value="auto" checked onchange="app.setTheme('auto')">
                        <span>Auto (System)</span>
                    </label>
                    <label class="radio-setting">
                        <input type="radio" name="theme" value="light" onchange="app.setTheme('light')">
                        <span>Light</span>
                    </label>
                    <label class="radio-setting">
                        <input type="radio" name="theme" value="dark" onchange="app.setTheme('dark')">
                        <span>Dark</span>
                    </label>
                </div>
                
                <div class="settings-section">
                    <h4>ü§ñ AI Features</h4>
                    <label class="toggle-setting">
                        <input type="checkbox" id="enable-ai-suggestions" checked onchange="app.toggleAISuggestions()">
                        <span>AI Workout Suggestions</span>
                    </label>
                    <label class="toggle-setting">
                        <input type="checkbox" id="enable-form-checks" checked onchange="app.toggleFormChecks()">
                        <span>AI Form Checks</span>
                    </label>
                </div>
            </div>
        </div>
    </div>

    <!-- Backend Settings Modal -->
    <div class="modal" id="backend-settings-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>‚òÅÔ∏è Sync Settings</h3>
                <button class="modal-close" onclick="app.closeBackendSettings()">‚úï</button>
            </div>
            <div class="modal-body">
                <div class="settings-section">
                    <h4>Storage Provider</h4>
                    <label class="radio-setting">
                        <input type="radio" name="provider" value="local" checked onchange="app.toggleProviderConfig('local')">
                        <span>Local Storage Only</span>
                    </label>
                    <label class="radio-setting">
                        <input type="radio" name="provider" value="nas" onchange="app.toggleProviderConfig('nas')">
                        <span>Synology NAS</span>
                    </label>
                    <label class="radio-setting">
                        <input type="radio" name="provider" value="onedrive" onchange="app.toggleProviderConfig('onedrive')">
                        <span>OneDrive</span>
                    </label>
                </div>
                <div id="nas-config" class="provider-config" style="display:none;">
                    <h4>NAS Configuration</h4>
                    <div class="form-group">
                        <label>NAS URL</label>
                        <input type="text" class="form-input" placeholder="http://192.168.1.100:5000" id="nas-url">
                    </div>
                    <div class="form-group">
                        <label>Username</label>
                        <input type="text" class="form-input" placeholder="Username" id="nas-username">
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" class="form-input" placeholder="Password" id="nas-password">
                    </div>
                </div>
                <div id="onedrive-config" class="provider-config" style="display:none;">
                    <h4>OneDrive Configuration</h4>
                    <div class="onedrive-status" id="onedrive-status">
                        <p>Not connected</p>
                    </div>
                    <button class="btn btn-primary" onclick="app.authenticateOneDrive()">
                        Connect OneDrive
                    </button>
                </div>
                <div class="sync-status">
                    <h4>Sync Status</h4>
                    <div id="sync-status-info">
                        <p>Last sync: <span id="last-sync">Never</span></p>
                        <p>Status: <span id="sync-status-text">Not configured</span></p>
                    </div>
                    <button class="btn btn-secondary" onclick="app.manualSync()">Sync Now</button>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="app.closeBackendSettings()">Cancel</button>
                <button class="btn btn-primary" onclick="app.saveBackendSettings()">Save</button>
            </div>
        </div>
    </div>

    <!-- Rest Timer -->
    <div class="rest-timer" id="rest-timer">
        <div class="rest-timer-content">
            <div class="rest-timer-label">Th·ªùi gian ngh·ªâ</div>
            <div class="rest-timer-time" id="rest-time">02:00</div>
            <div class="rest-timer-actions">
                <button class="rest-timer-btn" onclick="app.skipRest()">B·ªè qua</button>
                <button class="rest-timer-btn" onclick="app.addRestTime(30)">+30s</button>
            </div>
        </div>
    </div>

    <!-- PR Notification -->
    <div class="pr-notification" id="pr-notification" style="display:none;">
        <div class="pr-content">
            <span class="pr-icon">üèÜ</span>
            <span class="pr-text">Personal Record!</span>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toast-container"></div>

    <!-- Context Menu for units -->
    <div id="unit-context-menu" class="context-menu" style="display:none;position:absolute;z-index:1200;"></div>

    <!-- Main JS -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="js/analytics.js"></script>
    <script src="js/backend.js"></script>
    <script src="js/ai.js"></script>
    <script src="js/app.js"></script>

    <!-- PWA & Service Worker, Install Banner, Online/Offline, New Version Notify -->
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/service-worker.js')
                .then(registration => {
                    console.log('Service Worker registered');
                    registration.addEventListener('updatefound', () => {
                        const newWorker = registration.installing;
                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                app.showToast('New version available! Refresh to update.', 'info');
                            }
                        });
                    });
                })
                .catch(err => console.error('Service Worker registration failed:', err));
        }

        // Install PWA
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('install-banner').style.display = 'flex';
        });

        document.getElementById('install-btn').addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                if (outcome === 'accepted') {
                    console.log('PWA installed');
                }
                deferredPrompt = null;
                hideInstallBanner();
            }
        });

        function hideInstallBanner() {
            document.getElementById('install-banner').style.display = 'none';
        }

        // Handle offline/online status
        window.addEventListener('online', () => {
            document.getElementById('offline-indicator').style.display = 'none';
            app.showToast('Back online!', 'success');
            if (app.backend) {
                app.backend.processSyncQueue();
            }
        });

        window.addEventListener('offline', () => {
            document.getElementById('offline-indicator').style.display = 'flex';
            app.showToast('B·∫°n ƒëang offline', 'warning');
        });

        // Global click handler for menus
        document.addEventListener('click', function (e) {
            document.querySelectorAll('.exercise-menu').forEach(menu => {
                if (!menu.contains(e.target) && !e.target.classList.contains('btn-ex-action') && !e.target.classList.contains('menu-icon')) {
                    menu.style.display = 'none';
                }
            });
        });
    </script>
</body>
</html>